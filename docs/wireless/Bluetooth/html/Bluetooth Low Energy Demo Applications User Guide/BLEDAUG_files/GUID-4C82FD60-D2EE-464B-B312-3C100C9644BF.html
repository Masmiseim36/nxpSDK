<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xml:lang="en-us" lang="en-us">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<meta name="copyright" content="(C) Copyright 2005"/>
<meta name="DC.rights.owner" content="(C) Copyright 2005"/>
<meta name="DC.Type" content="topic"/>
<meta name="DC.Title" content="Using the Test Tool to perform secured OTAP"/>
<meta name="DC.Relation" scheme="URI" content="GUID-267A161F-8693-4A2D-B892-DA44D4673EEE.html"/>
<meta name="DC.Format" content="XHTML"/>
<meta name="DC.Identifier" content="GUID-4C82FD60-D2EE-464B-B312-3C100C9644BF"/>
<meta name="DC.Language" content="en-us"/>
<link rel="stylesheet" type="text/css" href="commonltr.css"/>
<title>Using the Test Tool to perform secured OTAP</title>
</head>
<body id="GUID-4C82FD60-D2EE-464B-B312-3C100C9644BF">


    <h1 class="title topictitle1">Using the Test Tool to perform secured OTAP</h1>

    <div class="body">
        <ol class="ol" id="GUID-4C82FD60-D2EE-464B-B312-3C100C9644BF__OL_XFT_JG2_DHB">
            <li class="li">Start the Test Tool application and go to OTA Updates &gt; OTAP Bluetooth LE.<div class="fig fignone"><span class="figcap">Figure 1. Test Tool application</span>
                    <img class="image" id="GUID-4C82FD60-D2EE-464B-B312-3C100C9644BF__IMAGE_QKN_YH2_DHB" src="GUID-DBBBF9B9-F4CD-4EB7-AE0A-4971182B1893-high.png"/>
                </div>
</li>

            <li class="li">Click the Browse button and select an image file. Select K3S in the Processor
                Selection dialogue.<div class="fig fignone"><span class="figcap">Figure 2. Processor selection</span>
                    <img class="image" id="GUID-4C82FD60-D2EE-464B-B312-3C100C9644BF__IMAGE_PRL_132_DHB" src="GUID-A2EEEE2E-A504-4717-9295-CF8A5D9B0E53-high.png"/>
                </div>
</li>

            <li class="li">Choose from the dropdown menu on the right side whether the file you selected
                contains both M4 and M0+ images, i.e. it has been generated by MCUXpresso IDE, or
                only the M4/M0+ image, i.e. it has been generated by IAR EW. The start address is
                the default one for the provided OTAP demos. If you have changed the project linker
                layout, pick the correct start address for the image.</li>

            <li class="li">Select which core images should be updated. If the initial selected image contains
                only the M4 or only the M0+ image but the user wants to update both, a second Browse
                button appears, and the user must select the second image file. As in the previous
                step, the start address is the default one. In this example screenshot, a .bin file
                containing the M4 image file has been selected, but the user wishes to update both
                core images, therefore they must also select the file containing only the M0+ image.<div class="fig fignone"><span class="figcap">Figure 3. K32W032 image information</span>
                    <img class="image" id="GUID-4C82FD60-D2EE-464B-B312-3C100C9644BF__IMAGE_T5H_232_DHB" src="GUID-73A1BF67-AABF-42C1-A6C4-E670B38A8492-high.png"/>
                </div>
</li>

            <li class="li">Only secured OTAP is supported for K32W032. The user can overwrite
                the 256-bit SBKEK (Secured Boot Key Encryption Key) used to encrypt the image. The
                key is secret and must be shared with the client board which decrypts the image. The
                way to share the key is left to the user. In the demos provided, the key is
                hardcoded in Test Tool and in the application residing on the client board. After
                the client application has received the image, it will write the pre-shared SBKEK at
                a known location in flash where it is read by the bootloader after reset.</li>

            <li class="li">Click OK. The user is prompted to save the resulting encrypted and
                signed image, with a .sbin extension. After saving, a dialog box appears with the
                SBKEK used to encrypt the image and the RHK (Root Hash Key), which is an SHA-256
                hash of the RSA public key for the certificate used to sign the image. As noted in
                step 5, the SBKEK must be shared with the client in a secured way. The RHK is public
                and is sent over-the-air as part of the OTAP process. It is also not modifiable by
                the user since it depends on the certificate.<div class="fig fignone"><span class="figcap">Figure 4. Security keys</span>
                    <img class="image" id="GUID-4C82FD60-D2EE-464B-B312-3C100C9644BF__IMAGE_SLV_M32_DHB" src="GUID-98042A69-C99D-4DAE-B071-582141182D29-high.png"/>
                </div>
<div class="note note"><span class="notetitle">Note:</span> If the user wants to use their own certificate, they must
                    overwrite the certificate used by Test Tool, specifically the files named
                    cert0_noca.der.crt (root certificate) and private.pem (RSA private key) located
                    in Secured/config inside the folder where Test Tool is installed.</div>
</li>

            <li class="li">The sector bitmap field in the OTAP Bluetooth LE view is used to
                determine which sectors is erased on the client board before writing the new image.
                By default, the entire useful flash is erased. The bitmap looks like
                this:<pre class="pre codeblock">0x<strong class="ph b">FF</strong>FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFE0</pre>
The
                bold bytes above represent the Non-Volatile Memory space in M0+’s flash (8 sectors *
                2K for each sector = 16K of NVM). To avoid the NVM being erased, after the secured
                image has been created the user can change FF to 00. The secured image is recreated
                – the NVM is not erased on the client board. This dialog box appears.<div class="fig fignone"><span class="figcap">Figure 5. Bitmap file update</span>
                    <img class="image" id="GUID-4C82FD60-D2EE-464B-B312-3C100C9644BF__IMAGE_FMW_N32_DHB" src="GUID-8477027D-BEE1-4262-A0E5-E88F4D8FE112-high.png"/>
                </div>
</li>

        </ol>

                   <p class="p"><strong class="ph b">Secured image format</strong></p>

        <div class="p">After the image files have been selected and the user clicks OK to generate the .sbin,
            Test Tool will create the secured image in the background using calls to the elftosb
            executable. For full documentation see the Kinetis elftosb User’s Guide. The following
            figure shows an overview of the .sbin file:<div class="fig fignone"><span class="figcap">Figure 6. Secured image format</span><img class="image" src="GUID-A28800A8-56CD-4138-92F2-EFFA17210CA3-high.png"/></div>
</div>

        <p class="p">The .sbin file will begin with two plaintext sections, the boot image header
            and the section table. The DEK dictionary contains one or more randomly generated keys
            used to encrypt the useful data. These keys are wrapped by the SBKEK chosen by the user
            as per RFC 3394. Encrypted sections follow, and the image authentication code is at the
            end. The only information needed by the bootloader on the client board to successfully
            authenticate and decrypt the image is the two keys: SBKEK for decryption, RHK for
            authentication.</p>


    </div>

<div class="related-links">
<div class="familylinks">
<div class="parentlink"><strong>Parent topic:</strong> <a class="link" href="GUID-267A161F-8693-4A2D-B892-DA44D4673EEE.html">Notes on multicore platforms and secured OTAP</a></div>
</div>
</div>

</body>
</html>